use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};

use crate::common::{CommonProperties, StixObject};
use crate::sdos::BuilderError;

/// Vulnerability SDO
#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
#[serde(rename_all = "kebab-case")]
pub struct Vulnerability {
    #[serde(flatten)]
    pub common: CommonProperties,
    pub name: String,
    pub description: Option<String>,
}

impl Vulnerability {
    pub fn builder() -> VulnerabilityBuilder {
        VulnerabilityBuilder::default()
    }
}

#[derive(Debug, Default)]
pub struct VulnerabilityBuilder {
    name: Option<String>,
    description: Option<String>,
    created_by_ref: Option<String>,
}

impl VulnerabilityBuilder {
    pub fn name(mut self, name: impl Into<String>) -> Self {
        self.name = Some(name.into());
        self
    }

    pub fn description(mut self, d: impl Into<String>) -> Self {
        self.description = Some(d.into());
        self
    }

    pub fn created_by_ref(mut self, r: impl Into<String>) -> Self {
        self.created_by_ref = Some(r.into());
        self
    }

    pub fn build(self) -> Result<Vulnerability, BuilderError> {
        let name = self.name.ok_or(BuilderError::MissingField("name"))?;
        let common = CommonProperties::new("vulnerability", self.created_by_ref);
        Ok(Vulnerability {
            common,
            name,
            description: self.description,
        })
    }
}

impl StixObject for Vulnerability {
    fn id(&self) -> &str {
        &self.common.id
    }

    fn type_(&self) -> &str {
        &self.common.r#type
    }

    fn created(&self) -> DateTime<Utc> {
        self.common.created
    }
}

impl From<Vulnerability> for crate::StixObjectEnum {
    fn from(v: Vulnerability) -> Self {
        crate::StixObjectEnum::Vulnerability(v)
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn vulnerability_builder() {
        let vuln = Vulnerability::builder()
            .name("CVE-2024-1234")
            .description("Remote code execution vulnerability")
            .build()
            .unwrap();

        assert_eq!(vuln.name, "CVE-2024-1234");
        assert_eq!(vuln.common.r#type, "vulnerability");
    }

    #[test]
    fn vulnerability_serialize() {
        let vuln = Vulnerability::builder()
            .name("CVE-2024-5678")
            .build()
            .unwrap();

        let json = serde_json::to_string(&vuln).unwrap();
        assert!(json.contains("\"type\":\"vulnerability\""));
        assert!(json.contains("\"name\":\"CVE-2024-5678\""));
    }
}
